name: "Testing"

on:
  push:
    branches:
      - "*"

jobs:
  Build_Image:
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout Project
        uses: actions/checkout@v4

      - name: Docker Meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ secrets.USERNAME_DOCKERHUB }}/mmmf
            ghcr.io/${{ github.actor }}/mmmf
          tags: type=raw,value=test
          flavor: onlatest=false

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.USERNAME_DOCKERHUB }}
          password: ${{ secrets.TOKEN_DOCKERHUB }}

      - name: Log in to Github Container Registry
        uses: docker/login-action@f054a8b539a109f9f41c372932f1ae047eff08c9
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.TOKEN_GITHUB }}

      - name: Set QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Build Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

  Image_Test:
    runs-on: ubuntu-22.04
    needs: Build_Image

    steps:
      - name: Checkout Project
        uses: actions/checkout@v4

      - name: Build Docker Image
        run: docker build -t mmmf-test:latest .

      - name: Create test data directory
        run: mkdir -p ./test-data

      - name: Start Docker Container
        run: |
          docker run -d --name mmmf-test \
            -p 5173:5173 \
            -v $PWD/test-data:/app/data \
            -e NODE_ENV=production \
            -e DEFAULT_LANGUAGE=en \
            mmmf-test:latest

      - name: Wait for server to start
        run: |
          echo "Waiting for server to be ready..."
          timeout 30 bash -c 'until curl -f http://localhost:5173/api/settings > /dev/null 2>&1; do sleep 2; done' || exit 1
          echo "Server is ready!"

      - name: Check server logs
        run: |
          echo "=== Server Logs ==="
          docker logs mmmf-test

          # Verify expected log messages
          docker logs mmmf-test 2>&1 | grep -q "Server running on port" || (echo "ERROR: Server start message not found" && exit 1)
          docker logs mmmf-test 2>&1 | grep -q "Environment: production" || (echo "ERROR: Environment message not found" && exit 1)

          echo "✅ Server logs verification passed"

      - name: Test API endpoints
        run: |
          echo "Testing API endpoints..."

          # Test GET /api/settings
          curl -f http://localhost:5173/api/settings || (echo "ERROR: GET /api/settings failed" && exit 1)
          echo "✅ GET /api/settings passed"

          # Test GET /api/transactions
          RESPONSE=$(curl -s http://localhost:5173/api/transactions)
          if [ "$RESPONSE" != "[]" ]; then
            echo "ERROR: Expected empty array from /api/transactions"
            exit 1
          fi
          echo "✅ GET /api/transactions passed"

          # Test GET /api/recurring
          RESPONSE=$(curl -s http://localhost:5173/api/recurring)
          if [ "$RESPONSE" != "[]" ]; then
            echo "ERROR: Expected empty array from /api/recurring"
            exit 1
          fi
          echo "✅ GET /api/recurring passed"

          # Test GET /api/credit-cards
          RESPONSE=$(curl -s http://localhost:5173/api/credit-cards)
          if [ "$RESPONSE" != "[]" ]; then
            echo "ERROR: Expected empty array from /api/credit-cards"
            exit 1
          fi
          echo "✅ GET /api/credit-cards passed"

      - name: Test frontend
        run: |
          echo "Testing frontend..."
          curl -f http://localhost:5173/ || (echo "ERROR: Frontend not accessible" && exit 1)
          curl -s http://localhost:5173/ | grep -q "<title>Budget Forecast App</title>" || (echo "ERROR: Frontend HTML not correct" && exit 1)
          echo "✅ Frontend test passed"

      - name: Test health check
        run: |
          echo "Testing health check..."
          curl -f http://localhost:5173/ || (echo "ERROR: Health check failed" && exit 1)
          echo "✅ Health check passed"

      - name: Stop and remove container
        if: always()
        run: |
          docker stop mmmf-test || true
          docker rm mmmf-test || true

  Cloudflare_Build_Test:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Project
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Dependencies
        run: npm install

      - name: Build Frontend
        run: npm run build

      - name: Verify build output
        run: |
          echo "Checking build artifacts..."
          test -d dist || (echo "ERROR: dist directory not found" && exit 1)
          test -f dist/index.html || (echo "ERROR: index.html not found" && exit 1)
          test -d dist/assets || (echo "ERROR: assets directory not found" && exit 1)
          echo "✅ Build artifacts verified"

      - name: Check wrangler configuration
        run: |
          echo "Validating wrangler.jsonc..."
          test -f wrangler.jsonc || (echo "ERROR: wrangler.jsonc not found" && exit 1)
          npx wrangler --version
          echo "✅ Wrangler configuration valid"
